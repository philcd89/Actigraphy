---
title: "Actigraphy Data Processing and Report"
output:
  html_document:
    df_print: paged
    code_folding: hide
    toc: true
    toc_float: true
    theme: spacelab
    includes:
    after_body: footer.html
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = getwd())
```

***

## Project Overview

This code imports, arranges, and outports Philips Respironics Actiwatch actigraphy variables for reporting and further analysis.  As of [date] this code and report is outputted to [file location, computer].  This code was created in March 2020 By Phil Desrochers.

#### Data Processing Methodology

This code was generated to reproduce the actigraphy scoring parameters generated by Phil Desrochers for the Cognition and Action Lab (now the SomNeuro Lab) and the University of Massachusetts Amherst.  The manual can be found on [Phil's Github](https://github.com/philcd98/Actigraphy).  Articles produced using this method include Mantua et al. (2016), Spencer et al. (2016), de Jong et al. (2016), Cremone et al. (2017), and Helm & Spencer (2019).  PDFs of these files can also be found on [Phil's Github](https://github.com/philcd98/Actigraphy).

#### Assumptions/Definitions

* Nighttime sleep on Sunday, Monday, Tuesday, Wednesday, and Thursday are counted as weekday sleep bouts
* Nighttime sleep on Friday and Saturday are counted as weekend sleep bouts
* Naps on weekdays are counted as weekday naps
* Naps on weekends are counted as weekend naps
* Sleep onset is defined as [INSERT LOGIC HERE]
* Sleep ofset is defined as [INSERT LOGIC HERE]

#### Variable Glossary

Forthcoming....

***

## Data output

```{r read in and format data, warning = FALSE, message=FALSE}

# GET LIBS AND READ IN DATA

library(tidyverse)
library(readxl)
library(readr)
library(tcltk)
library(shiny)

# Ask user to set working directory
# directory <- choose.dir()
# setwd(directory)

# Ask user to choose files to analyze
actFiles_list <- data.frame(tk_choose.files())
for (i in 1:nrow(actFiles_list)){
  actFiles_list$path[i] = dirname(as.character(actFiles_list$tk_choose.files..[i]))
  actFiles_list$filename[i] = basename(as.character(actFiles_list$tk_choose.files..[i]))
}

# Get record info
recordInfo = data.frame(actFiles_list$filename)
recordInfo = separate(recordInfo, actFiles_list.filename, into = c("Experiment", "Group", "Session", "SubID", "ExportMonth", "ExportDay", "ExportYear", "ExportHour", "ExportMin", "ExportSec", "ExportAM_PM", "New", "Analysis"), sep = "_")

#if file hasn't been processed, alert user and give them the option to cancel script
if (file.exists("Actigraphy_Processing_complete.txt")){
  ActiProcess = read.table("Actigraphy_Processing_complete.txt", header = FALSE)
  for (i in 1:nrow(actFiles_list)) {
    if (actFiles_list$filename[i] %in% ActiProcess$V1) {
      userChoice = tk_messageBox(type = "yesno", title = "ALERT!!", message = paste("ALERT!!!  ", actFiles_list$filename[i], "has already been processed!  Do you want to continue processing this file?"))
    }
  }
}

if(userChoice == "no"){
  stop("Actigraphy Processing Cancelled by User")
}

#Create list of dataframes to process based on file info
dfs_to_do = data.frame(matrix(ncol = 1, nrow = nrow(recordInfo)))
colnames(dfs_to_do)[1] = "df.names"
for (i in 1:nrow(recordInfo)) {
  dfs_to_do$df.names[i] = paste(recordInfo$Experiment[i], recordInfo$Group[i], recordInfo$Session[i], recordInfo$SubID[i], 'ActiData', sep = "_")
}

# import actigraphy files
#for (i in 1:nrow(actFiles_list)) {
findActivityEpoch = readLines(actFiles_list$filename[1])  #Read in file by rows     ALERT!!!! WILL NEED TO CHANGE "1" HERE!!!
ActEpochStart = which(findActivityEpoch == "\"Line\",\"Date\",\"Time\",\"Off-Wrist Status\",\"Activity\",\"Marker\",\"White Light\",\"Red Light\",\"Green Light\",\"Blue Light\",\"Sleep/Wake\",\"Interval Status\",")  #find header line
actigraphData = read.csv(actFiles_list$filename[1], skip = ActEpochStart+1, header = FALSE)   #Read again
names(actigraphData) = c("Line", "Date", "Time", "Off_Wrist_Status", "Activity", "Marker", "White_Light", "Red_Light", "Green_Light", "Blue_Light", "Sleep_Wake", "Interval_Status", "Dafuq")

#reformat cols
actigraphData$Dafuq = NULL

#Date
actigraphData = separate(actigraphData, Date, into = c("Month", "Day", "Year"), sep ='/')
actigraphData$Month = lapply(actigraphData$Month, function(x) {
  if (nchar(x) < 2) {
    paste("0", x, sep = '')
  } else {
    x
  }
})
actigraphData$Day = lapply(actigraphData$Day, function(x) {
  if (nchar(x) < 2) {
    paste("0", x, sep = '')
  } else {
    x
  }
})
actigraphData = unite(actigraphData, Date, Month, Day, Year, sep = '')

#Time
actigraphData = separate(actigraphData, Time, into = c("Hour", "Minute", "Second"), sep = ":")
actigraphData = separate(actigraphData, Second, into = c("Second", "AM_PM"), sep = " ")
actigraphData$Hour = lapply(actigraphData$Hour, function(x) {
  if (nchar(x) < 2) {
    paste("0", x, sep = '')
  } else {
    x
  }
})
actigraphData = unite(actigraphData, Time, Hour, Minute, Second, sep = ':')
actigraphData = unite(actigraphData, Time, Time, AM_PM, sep = ' ')

#Date_Time
actigraphData = unite(actigraphData, Date_Time, Date, Time, sep = ' ')
actigraphData$Date_Time = strptime(actigraphData$Date_Time, "%m%d%Y %I:%M:%S %p")


###########################################################

#Now, find marker section

findMarkerEpoch = readLines(actFiles_list$filename[3])  #Read in file by rows     ALERT!!!! WILL NEED TO CHANGE "1" HERE!!!
MarkerEpochStart = which(findMarkerEpoch == "\"Line\",\"Date\",\"Time\",\"Marker\",\"Interval Status\",")+1  #find header line
MarkerEpochEnd = which(findMarkerEpoch == "\"-------------------- Epoch-by-Epoch Data -------------------\"")-3  #find header line
markerData = read.csv(actFiles_list$filename[3], skip = MarkerEpochStart, nrow = MarkerEpochEnd-MarkerEpochStart, header = FALSE)   #Read again
names(markerData) = c("Line", "Date", "Time", "Marker", "Interval_Status", "Dafuq")


#reformat cols
markerData$Dafuq = NULL

#Date
markerData = separate(markerData, Date, into = c("Month", "Day", "Year"), sep ='/')
markerData$Month = lapply(markerData$Month, function(x) {
  if (nchar(x) < 2) {
    paste("0", x, sep = '')
  } else {
    x
  }
})
markerData$Day = lapply(markerData$Day, function(x) {
  if (nchar(x) < 2) {
    paste("0", x, sep = '')
  } else {
    x
  }
})
markerData = unite(markerData, Date, Month, Day, Year, sep = '')

#Time
markerData = separate(markerData, Time, into = c("Hour", "Minute", "Second"), sep = ":")
markerData = separate(markerData, Second, into = c("Second", "AM_PM"), sep = " ")
markerData$Hour = lapply(markerData$Hour, function(x) {
  if (nchar(x) < 2) {
    paste("0", x, sep = '')
  } else {
    x
  }
})
markerData = unite(markerData, Time, Hour, Minute, Second, sep = ':')
markerData = unite(markerData, Time, Time, AM_PM, sep = ' ')

#Date_Time
markerData = unite(markerData, Date_Time, Date, Time, sep = ' ')
markerData$Date_Time = strptime(markerData$Date_Time, "%m%d%Y %I:%M:%S %p")

#assign(dfs_to_do$df.names[i], actigraphData)
#}


```



Data output sent to [file path]






